---
title: "Florida Keys Reef Fish Biodiversity"
author: "Megan Hepner"
date: "April 28, 2017"
output: html_document
---

Rstudio Version 1.2.5019 
R 3.6.1 GUI 1.70 El Capitan build (7684)

### Inputs 
1. species-trait matrix
1. psu abundance dataframe
1. psu biomass dataframe

### Outputs 
1.  Functional dendogram (Fig: The final ultrametric functional dendrogram for 348 reef fish in the Florida Keys obtained using hierarchial agglometric clustering.)
+ Trait-matrix visualization 

1.  By *strata* for each sampling year (using PSU data)  
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness as effective number of species and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot 

1. By *strata grouped and subregion* for each sampling year (using PSU data) 
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot 

1. By *NTMR* for each sampling year (using PSU data) 
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness as effective number of species and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot 

1. Figure of the FKNMS coral reef tract with strata, subregions, and NTMR 

1. Statistics 
- Interpolate diversity for each year and strata using kriging 
+ Figure. Spatial distribution of each matrices over time. 
- Extract and interpolate the residuals of each index fitted against each other using GAM
+ temporal variable: YEAR
+ spatial variable: latitude, longitude
+ environmental variable: STRAT, habitat_cd, depth, bottom temperature 
+ management variable: NTMR 
- Calculate partial deviances 

### Reef Visual Census Background 

Reef fish community data used in this study were collected as part of the multi-agency Reef Visual Census (RVC) [Brandt et al., 2009](https://www.coris.noaa.gov/activities/fish_monitoring_protocol/). Fish communities were visually surveyed underwater annually in the mainland FKNMS (Lower Keys, Middle Keys and Upper Keys) from 1999 to 2012, and biennially from 2012 to 2016. The Dry Tortugas region was surveyed from 1999 to 2000 and biennially from 2004 to 2016.     

The RVC uses a stationary point count method within a randomly selected 7.5 m radius circular plot with a 200m map grid from 1999 to 2012 and 100m map grid from 2014 to 2016 to optimize the observation of conspicuous and diurnally active reef fish, specifically economically and ecologically important reef fish species [Bohnsack and Bannerot, 1986](https://docs.lib.noaa.gov/noaa_documents/NMFS/TR_NMFS/TR_NMFS_41.pdf). 

### Objective 

To analyze and compare changes in species richness, Simpson diversity, Shannon diversity and functional diversity in the Florida Keys National Marine Sanctuary (FKNMS) to reveal changes in temporal and spatial variability from 1999 â€“ 2016. The indices were assessed throughout the Florida Keys, between the upper and lower keys, between habitat types, and for different levels of management (Ecological Reserves (ER), Sanctuary Preservations Areas (SPA), and Special Use/Research Only Areas (SU/RO)). 

## Diversity indicse as effective number of species 

All diversity indices were computed as effective number of species. Effective number of species is the number of equally abundance species needed to produce the observed value of a diversity index (Jost, 2006; Jost et al., 2010; MacArthur, 1965). Jost, 2006 refers to these as true measures of diversity, where prior to the conversion the diversity indices are simply measures of entropy. 

- Species Richness is the number of species in a habitat sampled  

$Richness = \sum_{i=1}^S p_i^0$  

- Simpson diversity measures the probability that two individuals randomly selected from a sample will belong to different species.   
$Simpson = 1 - \sum_{i=1}^S p_i^2$  

- Shannon diveristy is a measure of entropy, it is the uncertainty in the species identity of a sample  

$Shannon = - \sum_{i=1}^S p_i \log_b p_i$  

- Functional diversity (Rao's Q) is a measure of pairwise functional differences between species weighted by their relative abundances   

$Rao Q = \sum_{i=1}^S-1 \sum_{j=i+1}^S d_i p_i p_j$

```{r setup, include= F}

#ln -s ~/Dropbox/big_csv big_csv - write in terminal window to link to 'big_csv' folder
#rm(list = ls())

#install.packages("rlang")
#update.packages("rlang")
library(devtools)
library(ape) #read.tree, as.phylo 
library(clue) #cl_consensus, cl_ultrametric, cl_dissimilarity,cl_ultrametric
library(cowplot) #get_legend 
#devtools::install_version("gridSVG", version="1.6-0")
devtools::install_github("timelyportfolio/d3treeR")
library(d3treeR) #d3treeR interactive traitmap
library(devtools) #install_github
library(FD) #gowdis
library(fpc) #pamk
install.packages("ggplot2",repos = c("http://rstudio.org/_packages", "http://cran.rstudio.com"))
library(ggplot2) #ggplot
library(grid)
library(gridExtra) #grid.arrange
library(htmlwidgets) #save interactive treemap and pie chart 
library(lattice)
library(mgcv) #gam
library(parallel) #clusterEvalQ,clusterExport,detectCores,makeCluster,parLapply
library(plotrix) #std.error
library(purrr) #map
library(readr) #saveRDS, read_rds, readRDS 
library(reshape2) #melt
devtools::install_github('jeremiaheb/rvc')
library(rvc) #getPSUAbundance, getStrataAbundance, getDomainAbundance 
library(tidyverse) #select, filter, mutate, group_by, summarize 
library(treemap) #treemap
library(vegan) #spec, diversity, richness 
library(webshot) #screenshot of interactive treemap and pie chart

map = purrr::map # override maps::map
select = dplyr::select #override MASS::select 
group_by =  dplyr::group_by #override plotly::group_by
summarise = dplyr::summarise #override plotly::summarise

```

## Fetch the RVC data from 
[NOAA's Southeast Fisheries Science Center server](https://grunt.sefsc.noaa.gov/rvc_analysis20/) using the [RVC package](https://github.com/jeremiaheb/rvc)
- Fetched weighted abundance and biomass data by domain, strata, and primary sampling units 

#### Sample Data Variables
- PRIMARY_SAMPLE_UNIT: A code indicating the primary sample unit in which a sample was collected.
- YEAR: A number indicating the calendar year.
- MONTH: A number indicating the month of the year.
- DAY: A number indicating the day of the month (EST).
- STATION_NR: A number indicating the secondary sampling unit within a given primary sample unit.
- LAT_DEGREES: Latitude of secondary sampling unit in decimal degrees).
- LON_DEGREES: Longitude of secondary sampling unit in decimal degrees).
- DEPTH: Average depth, in meters, of secondary sampling unit).
- UNDERWATER_VISIBILITY: visibility, in meters, at secondary sampling unit.
- MAPGRID_NR: A number indicating the primary sample unit.  
- HABITAT_CD: A code indicating the habitat type. 
- ZONE_NR: A code indicating the distance offshore: 
+ 1 - Inshore
+ 2 - Midchannel
+ 3 - Offshore
+ 4 - Fore-reef
- SUBREGION_NR: A number indicating the subregion.
- MPA_NR: A number identifying the marine protected area in which the sample was collected. Zero indicates unprotected status)
- SPECIES_NR: A number indicating the species for a sample 
- SPECIES_CD: A code indicating the species for a sample. Consists of the first three letters of the generic name and the first four of the specific name   
- LEN: The length, in cm, of a sample.      
- NUM: The number of individuals of a given species and length observed in a secondary sampling unit
- TIME_SEEN: A number indicating when, during sampling, an individual was observed. 1: In the first five minutes, 2: From 5-10 minutes, 3: After 10 minutes. 
- PROT: A boolean value indicating whether a sample was in a protected area or not 
+ 1 - protected area
+ 0 - not protected 
- STRAT: A code indicating the stratum in which a sample was taken. Differs by region.   
+ FMLR
+ FSLR
+ HRRF
+ INPR
+ MCPR 
+ OFPR
- REGION: A code indicating the region in which a sample was taken.
+ FLA KEYS (florida keys)
+ DRY TORT (dry tortugas)

#### Stratum Data Variables 
- REGION 
- YEAR 
- PROT 
- STRAT 
- NTOT: The number of possible primary sample units for a given year, region, stratum, and protected status 
- GRID_SIZE: The length (in meters) to a side of a primary sample unit for a given year, region, stratum, and protected status.

#### Taxonomic Data Variables 
- SPECIES_CD
- FAMILY
- SCINAME 
- COMNAME
- LC: Minimum length at capture, in centimeters
- LM: Median length at maturity, in centimeters.
- WLEN_A: The linear coefficient of the allometric growth equation in grams per millimeter (g/mm)
- WLEN_B: The exponential coefficient of the allometric growth equation

#### Benthic Data Variables 
- REGION: A code indicating the region. 
- YEAR: A number indicating the calendar year.
- PRIMARY_SAMPLE_UNIT: A code indicating the primary sample unit in which a sample was collected.
- STATION_NR: A number indicating the secondary sampling unit within a given primary sample unit.
- DEPTH: Average depth, in meters, of secondary sampling unit.
- MAX_HARD_RELIEF: The maximum height, in meters, of hard relief (e.g. hard corals, rock).
- MAX_SOFT_RELIEF: The maximum height, in meters, of soft relief (e.g. soft corals, sponges).
- AVG_HARD_RELIEF: The average height, in meters, of hard relief.
- HARD_REL_PCT_0: Percentage of hard relief less than 0.2 meters.
- HARD_REL_PCT_1: Percentage of hard relief between 0.2 and 0.5 meters.
- HARD_REL_PCT_2: Percentage of hard relief between 0.5 and 1.0 meters.
- HARD_REL_PCT_3: Percentage of hard relief between 1.0 and 1.5 meters.
- HARD_REL_PCT_4: Percentage of hard relief greater than 1.5 meters.
- PCT_SAND: Percentage of abiotic cover that is sand.
- PCT_HARD_BOTTOM: Percentage of abiotic cover that is hard bottom.
- PCT_RUBBLE: Percentage of abiotic cover that is rubble.
- PCT_CORAL: Percentage of biotic hardbottom that is coral.
- PCT_OCTO: Percentage of biotic hardbottom that is octocoral.
- PCT_SPONGE: Percentage of biotic hardbottom that is sponge.

#### Function: getDomainDensity 
- YEAR
- REGION
- SPECIES_CD
- density: Domain-wide mean density for a stratified random survey  
- var: Variance in average density per secondary sampling unit
- n: Number of primary sampling units sampled
- nm: Number of secondary sampling units sampled
- N: Number of total possible primary sample units
- NM: Number of possible secondary sampling units
- length_class: The length class or bin. Only present if length_bins is not NULL. The notation, [lower, upper), is inclusive of the lower bound, but exclusive of the upper bound
- protected_status: The protected status. Only present if merge_protected is FALSE

#### Florida Keys Strata
1. FSLR - Forereef Shallow Linear Reef (<6m)
2. FMLR - Forereef Midchannel Linear Reef (6-18m)
3. FDLR - Forereef Deep Linear Reef (18-33m)
4. INPR - Inshore patch reef
5. MCPR - Midchannel Patch Reef 
6. OFPR - Offshore Patch Reef
7. HRRF - High Relief Reef (Spur and Groove)

```{r pull data}

spp_list = read_csv("Data/spp_list.csv")

fk1999<- getRvcData(1999, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk1999$taxonomic_data$SPECIES_CD  
psu_abunfk1999 <- getPSUAbundance(fk1999, spp_list, merge_protected = F)
write_csv(psu_abunfk1999, 'Data/psu_abunfk1999.csv') #1999

fk2000<- getRvcData(2000, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2000$taxonomic_data$SPECIES_CD 
psu_abunfk2000 <- getPSUAbundance(fk2000, spp_list, merge_protected = F)  
write_csv(psu_abunfk2000, 'Data/psu_abunfk2000.csv') #2000

fk2001<- getRvcData(2001, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2001$taxonomic_data$SPECIES_CD 
psu_abunfk2001 <- getPSUAbundance(fk2001, spp_list, merge_protected = F) 
write_csv(psu_abunfk2001, 'Data/psu_abunfk2001.csv') #2001

fk2002<- getRvcData(2002, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2002$taxonomic_data$SPECIES_CD 
psu_abunfk2002 <- getPSUAbundance(fk2002, spp_list, merge_protected = F) 
write_csv(psu_abunfk2002, 'Data/psu_abunfk2002.csv') #2002

fk2003<- getRvcData(2003, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2003$taxonomic_data$SPECIES_CD 
psu_abunfk2003 <- getPSUAbundance(fk2003, spp_list, merge_protected = F) 
write_csv(psu_abunfk2003, 'Data/psu_abunfk2003.csv') #2003

fk2004<- getRvcData(2004, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2004$taxonomic_data$SPECIES_CD 
psu_abunfk2004 <- getPSUAbundance(fk2004, spp_list, merge_protected = F)
write_csv(psu_abunfk2004, 'Data/psu_abunfk2004.csv') #2004

fk2005<- getRvcData(2005, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
spp_list<- fk2005$taxonomic_data$SPECIES_CD 
psu_abunfk2005 <- getPSUAbundance(fk2005, spp_list, merge_protected = F) 
write_csv(psu_abunfk2005, 'Data/psu_abunfk2005.csv') #2005

fk2006<- getRvcData(2006, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
spp_list<- fk2006$taxonomic_data$SPECIES_CD 
psu_abunfk2006 <- getPSUAbundance(fk2006, spp_list, merge_protected = F) 
write_csv(psu_abunfk2006, 'Data/psu_abunfk2006.csv') #2006

fk2007<- getRvcData(2007, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2007$taxonomic_data$SPECIES_CD 
psu_abunfk2007 <- getPSUAbundance(fk2007, spp_list, merge_protected = F) 
write_csv(psu_abunfk2007, 'Data/psu_abunfk2007.csv') #2007

fk2008<- getRvcData(2008, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
spp_list<- fk2008$taxonomic_data$SPECIES_CD 
psu_abunfk2008 <- getPSUAbundance(fk2008, spp_list, merge_protected = F) 
write_csv(psu_abunfk2008, 'Data/psu_abunfk2008.csv') #2008

fk2009<- getRvcData(2009, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2009$taxonomic_data$SPECIES_CD 
psu_abunfk2009 <- getPSUAbundance(fk2009, spp_list, merge_protected = F) 
write_csv(psu_abunfk2009, 'Data/psu_abunfk2009.csv') #2009 

fk2010<- getRvcData(2010, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2010$taxonomic_data$SPECIES_CD 
psu_abunfk2010 <- getPSUAbundance(fk2010, spp_list, merge_protected = F) 
write_csv(psu_abunfk2010, 'Data/psu_abunfk2010.csv') #2010

fk2011<- getRvcData(2011, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2011$taxonomic_data$SPECIES_CD 
psu_abunfk2011 <- getPSUAbundance(fk2011, spp_list, merge_protected = F) 
write_csv(psu_abunfk2011, 'Data/psu_abunfk2011.csv') #2011

fk2012<- getRvcData(2012, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2012$taxonomic_data$SPECIES_CD 
psu_abunfk2012 <- getPSUAbundance(fk2012, spp_list, merge_protected = F)
write_csv(psu_abunfk2012, 'Data/psu_abunfk2012.csv') #2012

fk2014<- getRvcData(2014, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
spp_list<- fk2014$taxonomic_data$SPECIES_CD 
psu_abunfk2014 <- getPSUAbundance(fk2014, spp_list, merge_protected = F) 
write_csv(psu_abunfk2014, 'Data/psu_abunfk2014.csv') #2014

fk2016<- getRvcData(2016, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
spp_list<- fk2016$taxonomic_data$SPECIES_CD 
psu_abunfk2016 <- getPSUAbundance(fk2016, spp_list, merge_protected = F) 
write_csv(psu_abunfk2016, 'Data/psu_abunfk2016.csv') #2016

fk2018<- getRvcData(2018, "FLA KEYS")
spp_list<- fk2018$taxonomic_data$SPECIES_CD #402 species 
psu_abunfk2018 <- getPSUAbundance(fk2018, spp_list, merge_protected = F) 
write_csv(psu_abunfk2018, 'Data/psu_abunfk2018.csv') #2016

fk2018 = getRvcData(2016, "FLA KEYS")
fk2018$sample_data = psu_abunfk2018
fk2018$stratum_data$YEAR = 2018 
psu_abunfk2018 = getPSUAbundance(fk2018, spp_list$spp_list)
write_csv(psu_abunfk2018, "Data/psu_abunfk2018.csv") #2018 

```

```{r bind data}

##FK abundance psu 
cat("bind all csv's\n") #concatenate and print - character string naming the file to print to
  d = data_frame()
    for (f in list.files('Data/FK_PSU_Abundance_Data/', pattern="*.csv", full.names=T)){
      cat(' ', f,'\n')
      d_f = read_csv(
        f, #path to a file 
        progress=F, #progress: Display a progress bar
        trim_ws=T, #trim_ws: leading and trailing whitespace are trimmed 
        col_types = cols(
          protected_status = col_character()))  #column specification - must contain one column specification for each column
      d = bind_rows(d, d_f)
    } 
  
write_csv(d, 'Data/psu_fk_abun_1999-2018.csv')

```

### Florida Keys Primary Sampling Unit 

```{r clean psu abundance data}

  #read in data 
  psu_fk_abun <- read_csv("Data/psu_fk_abun_1999-2018.csv",
                          col_types = cols(protected_status = col_character()))
  #dim(psu_fk_abun) #3,697,914 x 10
  
  length(unique(psu_fk_abun$SPECIES_CD)) #401 species 

  #remove species not identified in species level and protected status all 
  psu_fk_abun_no_spp = psu_fk_abun %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$'))  %>% #370 species 
    filter(!abundance == "0") %>% #remove species with abundance = 0 #319 species 
    filter(stringr::str_detect(protected_status, 'all')) #remove duplicates of 'all'
  #dim(psu_fk_abun_no_spp) #204,342 x 10
  
  psu_abun_sum <- psu_fk_abun_no_spp %>%
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT) %>%
    summarize(abundance_sum = sum(abundance)) %>% #sum the abundance values and remove any PSU's with no species
    filter(!abundance_sum == "0") %>% #redundant since already removed species = 0 above 
    filter(!abundance_sum <= 1) %>% #remove PSU's with <1 species in order to calculate diversity [2006,602U INPR],  [2016,  1010U, INPR],  [2018, 1004U, INPR], [2018, 1013U, INPR]
    filter(!abundance_sum > 100000 ) #outlier 2001 PSU 222U HRRF abundance 100,229 counts 
    #dim(psu_abun_sum) #5269*4
  
  #remove follow PSU [2006,602U INPR],  [2016,  1010U, INPR],  [2018, 1004U, INPR], [2018, 1013U, INPR]
  psu_fk_abun_no_spp = psu_fk_abun_no_spp[!(
    psu_fk_abun_no_spp$YEAR == "2006" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "602U" | 
      psu_fk_abun_no_spp$YEAR == "2016" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "1010U" |
      #psu_fk_abun_no_spp$YEAR == "2018" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "1004U" |
      #psu_fk_abun_no_spp$YEAR == "2018" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "1013U" |
      psu_fk_abun_no_spp$YEAR == "2001" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "222U"),] 
  dim(psu_fk_abun_no_spp) #204280*4
  
  write_csv(psu_fk_abun_no_spp, "Data/psu_fk_abun_no_spp.csv")
  
  length(unique(psu_fk_abun_no_spp$SPECIES_CD)) #319 species 
  species_list = as.data.frame(unique(psu_fk_abun_no_spp$SPECIES_CD))
  write_csv(species_list, "Data/species_list.csv")
  
  length(unique(psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT)) #1671 sampling events 
  
  RVCdata_FK = read_rds('Data/RVCdata_FK.rds')
  family = RVCdata_FK$taxonomic_data
  psu_family = left_join(psu_fk_abun_no_spp, family, by= "SPECIES_CD")
  
  psu_family_group <- psu_family %>%
    group_by(FAMILY) %>%
    summarize(abundance_sum = sum(abundance)) %>%
    filter(abundance_sum != "0") %>%
  mutate(fam_percent = (abundance_sum/sum(abundance_sum))*100) %>%
  arrange(desc(fam_percent))
  
  write_csv(psu_family_group, "psu_family_group.csv")
    
  #FAMILY abundance_sum fam_percent
  # Family Name          abundance sum    percent
# 1 Labridae             406606.          20.7%  
# 2 Pomacentridae        343083.          17.4%  
# 3 Haemulidae           332576.          16.9%  
# 4 Gobiidae             201174.          10.2%  
# 5 Scaridae             180292.          9.17% 
  
  psu_common <- psu_family %>%
    group_by(COMNAME) %>%
    summarize(abundance_sum = sum(abundance)) %>%
    filter(abundance_sum != "0") %>% #removes 32 species 
  mutate(com_percent = (abundance_sum/sum(abundance_sum))*100) %>%
  arrange(desc(com_percent))
  
  write_csv(psu_common, "psu_common.csv")
  
  #COMNAME                  abundance_sum   com_percent
# 1 Bicolor Damselfish       226261.        11.5% 
# 2 Bluehead                 212810.        10.8% 
# 3 Masked Goby              174525.        8.87%
  
  psu_sciname <- psu_family %>%
    group_by(SCINAME) %>%
    summarize(abundance_sum = sum(abundance)) %>%
    filter(abundance_sum != "0") %>% #removes 32 species 
  mutate(com_percent = (abundance_sum/sum(abundance_sum))*100) %>%
  arrange(desc(com_percent))

```



## Functional distance trait based matrix (from Lefcheck et al., 2014 ChessMap.Rmd)

Gowdis computes the Gower (1971) similarity coefficient exactly as described by Podani (1999), then converts it to a dissimilarity coefficient by using D = 1 - S

```{r Functional distance matrix, eval = F}

knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("Data/func_dist_rds")){
 
  trait_matrix = read_csv('Data/species_trait_matrix_319_spp.csv') #319 species
  
  trait_matrix_scientific_name = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_scientific_name)=trait_matrix_scientific_name$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist = gowdis(trait_matrix_scientific_name, ord="podani")
  
  trait_matrix_common = trait_matrix %>%
    as.tibble() %>%
    mutate(
      Common_name = toupper(as.character(Common_name))) %>% 
    arrange(Common_name)%>% 
    select(Common_name, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      Common_name, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_common)=trait_matrix_common$Common_name 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.common = gowdis(trait_matrix_common, ord="podani")
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist, method=i))
  par(mfrow=c(3,2))
  for(i in 1:length(trees)) {plot(trees[[i]])} #plots the 5 different kinds of trees 
  
  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Plot each tree
  par(mfrow=c(3,2))
  for (i in 1:length(trees.ultra)) {plot(trees.ultra[[i]])} #plots the 5 different kinds of trees 
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
  par(mar=c(1,1,1,1))
  plot(consensus.tree, horiz=T)
  
  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist,method="spectral"))) 
  #Cross-dissimilarities using spectral ultrametric distance:
  #Single = 57.80006
  #complete = 100.0702
  #average = 13.57471
  #mcquitty = 34.08532
  #ward.D = 2759.852
  #consensus =  1039.107
  
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist,traits.dist,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  13.57471
  
  #Scale by the max value so that all values are between 0-1
  func.dist=func.dist/max(func.dist)
  saveRDS(func.dist, "Data/func_dist_rds")
  
} else { #read data 
  func.dist = read_rds("Data/func_dist_rds")
} 

func_dist_common = read_rds("Data/func_dist_common_name_rds") 
func_dist_phy_common = as.phylo(as.hclust(func_dist_common))

#Plot the best tree - average 
#removes 298/348 species 
pdf("functional_diversity/functional_dendrogram_2.pdf", width = 7, height = 10)
sup = drop.tip(func_dist_phy_common, sample(func_dist_phy_common$tip.label)[1:298])
par(mfrow=c(1,1)) 
plot(sup, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 1.5)
dev.off()

#removes 150/348 species 2 pages
pdf("functional_diversity/functional_dendrogram_2.pdf", width = 7, height = 20)
sup = drop.tip(func_dist_phy_common, sample(func_dist_phy_common$tip.label)[1:150])
par(mfrow=c(1,1)) 
plot(sup, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 1.5)
dev.off()

#with scale 
pdf("functional_diversity/functional_dendrogram.pdf", width = 8.5, height = 70) 
#par(mar=c(0,0,0,0)) #number of lines of margins for bottom, left, top, right
par(pin=c(4.5,65))         #plot dimensions (width, height)
plot(func_dist_common, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 1)
dev.off()

tiff("functional_diversity/functional_dendrogram.tiff", width = 8.5, height = 70) 
#par(mar=c(0,0,0,0)) #number of lines of margins for bottom, left, top, right
par(pin=c(4.5,65))         #plot dimensions (width, height)
plot(func_dist_common, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 1)
dev.off()

#with scale 
tiff("fd.tiff", width = 8.5, height = 70, units = "in", res = 300)
par(pin=c(3.5,65))         #plot dimensions (width, height)
plot(func_dist_common, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 1)
dev.off()

#Plot the best tree - average 
pdf("functional_diversity/functional_dendrogram.pdf", width = 7, height = 80) 
par(mfrow=c(1,1))         #nc-by-nr array 
par(mar=c(2,1,0,2))  #number of lines of margins for bottom, left, top, right 
par(pin=c(5,70))    #plot dimensions (width, height)
plot(func.dist, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 1.5, cex.lab = 1)
dev.off()

#Plot the best tree - average 
#removes 260/348 species 
pdf("functional_dendrogram.pdf", width = 7, height = 10)
sup = drop.tip(func.dist, sample(func.dist$tip.label)[1:260])
par(mfrow=c(1,1)) 
plot(sup, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 2)
dev.off()

pdf("functional_dendrogram.pdf", width = 7, height = 70)
par(mfrow=c(1,1)) 
plot(func.dist, horiz=TRUE, main = "Functional Dendrogram", cex = 0.5, label.offset=0.025, edge.width = 1, cex.main = 2) #cex.lab = 0.5
dev.off()

#Phylogenetic tree with 348 tips and 347 internal nodes. 
func.dist.phy = as.phylo(as.hclust(func.dist))

#Write newick tree
write.tree(func.dist.phy, "functional_diversity/functional_dendrogram.nwk")
#write.nexus(func.dist.phy, "functional_diversity/functional_dendrogram.nex") 

tree <- read.tree("functional_diversity/functional_dendrogram.nwk")
# List of 4
#  $ edge       : int [1:694, 1:2] 
#  $ Nnode      : int 347
#  $ tip.label  : chr [1:348] 
#  $ edge.length: num
# - attr(*, "class")= chr "phylo"
# - attr(*, "order")= chr "cladewise"

# Phylogenetic tree with 348 tips and 347 internal nodes.
# Tip labels:
# 	KYP_SECT, ALE_CILI, ELO_SAUR, HAR_JAGU, CEN_UNDE, TYL_CROC, ...
# Rooted; includes branch lengths.

plot(tree, label.offset=0.2, edge.width = 2, type = "cladogram")  
nodelabels() #add node numbers
tiplabels() #add tip numbers

ggtree(tree, branch.length = T) +
  ggtitle("Functional Dendogram") +
  geom_tiplab()+
  geom_text(aes(x = branch, label=branch.length), vjust = -.5) +
  theme_tree2()

ggtree(tree, layout= "circular") +
  ggtitle("Functional Dendogram") +
  geom_tiplab(size = 1, aes(angle=angle))+
  theme_tree2()

# transformed to a tidy data.frame by fortify method
tree_data <- fortify(tree) #node; parent; branch.length; x; y; label; isTip; branch; angle 
head(tree_data)

#Visualize species' differences in multivariate trait space
#Perform k-means clustering with no a priori specification for k
traits.kclus= pamk(traits.dist, krange=2:10) 

traits.kclus.common= pamk(traits.dist.common, krange=2:10)

#krange: integer vector. Numbers of clusters which are to be compared by the average silhouette width criterion.
#traits.kclus$nc = 10 
#traits.kclus$crit 0.0000000 0.2374706 0.2362513 0.2355555 0.2681756 0.2581352 0.2759547 0.2852216 0.3006077 0.3062123

# #Perform nonmetric multidimensional scaling (NMDS) on functional dendrogram
traits_nmds = metaMDS(traits.dist,k=traits.kclus$nc,trymax=20)

traits_nmds.common = metaMDS(traits.dist.common,k=traits.kclus.common$nc,trymax=300)
#k = Number of dimensions

#*** No convergence -- monoMDS stopping criteria:
#499: no. of iterations >= maxit
#1: stress ratio > sratmax

# Dimensions: 10 
# Stress:     0.03545178 
# Stress type 1, weak ties
# No convergent solutions - best solution after 500 tries
# Scaling: centring, PC rotation 
# Species: scores missing


# #Plot in two dimensions - doesn't work 
par(mar=c(4,4,1,1))
ordiplot(traits_nmds.common,type="n") #type="n"type="points"

#Assign colors to different groups
groups=levels(factor(traits.kclus.common$pamobject$clustering))
points.symbols=15:16
points.colors=c("firebrick3","cornflowerblue")
for(i in seq_along(groups)) {
  points(traits_nmds.common$points[traits.kclus.common$pamobject$clustering==groups[i],],
         pch=points.symbols[i],col=points.colors[i],cex=1.4) } 
ordispider(traits_nmds.common,factor(traits.kclus.common$pamobject$clustering),label=F)
ordihull(traits_nmds.common,factor(traits.kclus.common$pamobject$clustering),lty="dotted")
orditorp(traits_nmds.common,dis="sites",pcex=0,air=0.5,col="grey10",cex=0.8)

```

#Calculate Richness, Simpson and Shannon diversity  
```{r psu biodiversity}

if(!file.exists("psu_div_rds")){
  
  #read in psu abundance data 
  psu_fk_abun <- read_csv("Data/psu_fk_abun_no_spp.csv", 
                          col_types = cols(
                            protected_status = col_character()))
  #dim(psu_fk_abun) #198,409*10
  
  #read in trait matrix 
  trait_matrix = read_csv('Data/species_trait_matrix_319_spp.csv')
  
  #trait matrix needs to be alphabetically for FD code 
  trait_matrix = trait_matrix %>%
    as_tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)
  
  #compute diversity indices by PSU  
  psu_diversity = psu_fk_abun %>%  
    select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT,PROT,SPECIES_CD, abundance) %>% #tibble: 198409 x 6
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT) %>% 
    nest(-YEAR, -PRIMARY_SAMPLE_UNIT, -STRAT, -PROT)
    
  psu_diversity = psu_diversity %>%   
    mutate(
      data_wide = map(data, function(x) 
        full_join(x, trait_matrix %>% select(SPECIES_CD), by='SPECIES_CD') %>%
          mutate(abundance = ifelse(is.na(abundance), 0, abundance)) %>%
          spread(SPECIES_CD, abundance, fill =0)),
      data_wide = map(data, ~ spread(data=.x, SPECIES_CD, abundance, fill =0)), 
      richness = map( #species richness
        data_wide, 
        function(x) specnumber(x)),
      simpson = map( #simpson diversity as effective number of species 
        data_wide,
        function(x) 1/(1 - diversity(x, index = 'simpson'))),
      shannon = map( #shannon diversity as effective number of species 
        data_wide, 
        function(x) exp(diversity(x,  index = 'shannon')))) %>% 
    unnest(richness, simpson, shannon)
  
  saveRDS(psu_diversity, "Data/psu_div_rds")

} else { #read data 
  psu_div = read_rds("Data/psu_div_rds")
}

```

# Calculate Functional Diversity and Evenness 
```{r biodiversity 2.0}

  func.dist = read_rds("Data/func_dist_rds")
  
  #read in trait matrix 
  traits = read.csv('Data/species_trait_matrix_319_spp.csv')

  #Set rownames on traits and remove other info
  rownames(traits) <- traits$SPECIES_CD
  traits <- traits[, -c(1:4)]
  #Convert rownames to all caps
  rownames(traits) <- toupper(rownames(traits))
  
  psu_fk_abun <- read_csv("Data/psu_fk_abun_no_spp.csv", 
                          col_types = cols(
                            protected_status = col_character()))

  abund = psu_fk_abun %>% 
    select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT,PROT, SPECIES_CD, abundance) %>%
    arrange(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT)
  #204,280 * 6
  
  # Cast abundance longways (species as columns)
  abundmat = spread(abund, SPECIES_CD, abundance, fill = 0)
  #dim(abundmat) #5270  323
  
  # What is up with these species not being in the trait matrix??
  checkthese = colnames(abundmat)[!colnames(abundmat) %in% rownames(traits)]
  
  # Subset species whose names only appear in traits
  abundmat = abundmat[colnames(abundmat) %in% rownames(traits)] 
  #dim(abundmat) #5,270    319
  
  # Drop communities with no species (roughly 500 sites)
  abundmat <- abundmat[!rowSums(abundmat) == 0,] 
  #dim(abundmat) #5,270     319
  abundmat <- abundmat[!rowSums(abundmat) == 1,]
  #dim(abundmat) #5270  319
  
  #Calculate relative values for community matrix
  rel.mat=abundmat/apply(abundmat,1,sum)
  
  #Compute species diversity
  species.dist=matrix(1,ncol(abundmat),ncol(abundmat))-diag(rep(1,ncol(abundmat))) 
  species.div=1/(1-apply(rel.mat,1,function(x) t(x) %*% species.dist %*% x))
  
  #Compute evenness (as in Jost 2010 Diversity)
  evenness=log(species.div)/log(rowSums(abundmat>0))
  
  #Ensure that all evenness calculations are not >1 (bug)
  func.div=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist) %*% x))
  
  #Bind all to the original dataframe
  diversity = cbind(evenness,species.div,func.div)
  diversity = as.tibble(diversity)
  
  psu_diversity = psu_diversity %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT, richness, simpson, shannon)%>%
    arrange(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT)
  
  abund_sum = psu_fk_abun %>% 
      select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT,PROT, SPECIES_CD, abundance) %>%
      arrange(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT)%>%
      group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT)%>%
      summarize(abundance_sum = sum(abundance))%>%
    select(abundance_sum)
  
  RVC_biodiversity_calculated = bind_cols(abund_sum, psu_diversity,diversity)
  
write_csv(RVC_biodiversity_calculated, "Data/RVC_biodiversity_calculated.csv")
  
```

## Trait matrix visualization 

[http://jkunst.com/r/pokemon-visualize-em-all/]
[https://d3js.org/]
[http://www.buildingwidgets.com/blog/2015/7/22/week-29-d3treer-v2]

```{r trait visualization}

trait_matrix = read_csv('Data/species_trait_matrix_319_spp.csv')

trait_matrix_treemap = trait_matrix %>%
  select(Common_name, Maxlength, Trophic_level, Trophic_group, Water_column,Diel_activity,Substrate_type,Complexity, Gregariousness) %>% 
  group_by(Maxlength,
           Trophic_level,
           Trophic_group,
           Water_column,
           Diel_activity,
           Substrate_type,
           Complexity,
           Gregariousness) %>%
  summarise(n = n())%>% 
  ungroup() %>%
  as.data.frame()

treemap2 = 
  d3treeR::d3tree2(
    treemap(
      dtf = trait_matrix_treemap,
      index = c("Trophic_group", "Diel_activity", "Substrate_type", "Trophic_level", "Water_column","Maxlength","Complexity","Gregariousness"),
      vSize = "n", 
      vColor = "Trophic_group",
      type = "index"),
    #title = "Reef Fish Traits",
    #fontsize.title = 14, 
    #algorithm = "squarified"
    rootname = "Species Traits")

treemap2

htm = "./htmlwidget_treemap2.html"
saveWidget(treemap2, htm)

png = "./htmlwidget_treemap2.png"
webshot(htm, png)

trait_matrix_treemap3 = trait_matrix %>%
  select(Common_name, Maxlength, Trophic_level, Trophic_group, Water_column,Diel_activity,Substrate_type,Complexity, Gregariousness) %>% 
  group_by(
           Trophic_group,
           Water_column,
           Diel_activity,
           Substrate_type
           ) %>%
  summarise(n = n())%>% 
  ungroup() %>%
  as.data.frame()

treemap3 = 
  d3treeR::d3tree2(
    treemap(
      dtf = trait_matrix_treemap3,
      index = c("Trophic_group", "Diel_activity", "Substrate_type", "Water_column"),#"Trophic_level" #"Diel_activity", "Substrate_type", "Water_column", "Complexity", "Substrate_type", "Trophic_level"),
      vSize = "n", 
      vColor = "Trophic_group",
      type = "index"),
    #title = "Reef Fish Traits",
    #fontsize.title = 14, 
    #algorithm = "squarified"
    rootname = "Species Traits")

```

## Plots

- create multiplot function from (https://stackoverflow.com/questions/24387376/r-weird-error-could-not-find-function-multiplot)

 Questions

- Are diversity values and grouped strata related? 
- Are diversity values and subregions related? 
- Are diversity values and protection level related?

Group strata by: patch reef, forereef, and high relief 

```{r Plot by strata grouped and year} 
  
  all_matrices_data = read_csv("Data/RVC_biodiversity_calculated.csv")
  
  matrices_strat_grouped = all_matrices_data %>% 
    mutate(
      STRAT_GROUPED = #group strata 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    group_by(YEAR, STRAT_GROUPED) %>% 
    summarize( #calculate mean, sd, min, max, se
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  write_csv(matrices_strat_grouped, "Data/matrices_strat_grouped.csv")

# by STRAT_GROUPED and YEAR
#abundance
ab_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_year_and_strata_grouped.pdf", path="Figures")

#richness
rich_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=richness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.1)+
  labs(title= "D) Richness", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_year_and_strata_grouped.pdf", path="Figures")

#simpson
sim_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=simpson_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.1)+
  labs(title= "E) Simpson", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="simpson_by_year_and_strata_grouped.pdf", path="Figures")

#evenness
eve_gs = ggplot(matrices_strat_grouped,aes(x=YEAR,y=evenness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean relative evenness",colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
      legend.position="none", #right
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="evenness_by_year_and_strata_grouped.pdf", path="Figures")

#functional
func_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=func.div_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="functional_diversity_by_year_and_strata_grouped.pdf", path="Figures")

#save legend
for_legend_gs_vert = ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ 
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_gs_vert <- get_legend(for_legend_gs_vert)

for_legend_gs_horiz = ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ 
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
    theme(
      legend.position="bottom", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_gs_horiz <- get_legend(for_legend_gs_horiz)

#combine multiple plots
#all plots on one page
g_gs <- grid.arrange(ab_gs,bio_gs,eve_gs,rich_gs,sim_gs,shan_gs,func_gs,legend_gs_vert,ncol=2)
ggsave(file="all_indices_by_year_and_strata_grouped.pdf", g_gs, width=7, height=10, path="big_csv/plots")

#plots on two pages - letters in plot titles will need to be changed so they make sense on two pages (i.e., A-C and A-D)
g3 <- grid.arrange(ab_gs,bio_gs,eve_gs,legend_gs_vert,ncol=2)
ggsave(file="ab_bio_eve_by_year_and_strata_grouped.pdf", g3, width=7, height=5, path="big_csv/plots")

g4 <- grid.arrange(arrangeGrob(rich_gs,sim_gs,ncol=2),arrangeGrob(shan_gs,func_gs,ncol=2),legend_gs_horiz,nrow=3,heights=c(2,2,.4))
ggsave(file="rich_shan_sim_func_by_year_and_strata_grouped.pdf", g4, width=7, height=6, path="big_csv/plots")


### ***Don't need to combine plots by STRAT and by YEAR just YEAR & STRAT for now***

### ***Didn't run the code below -KS
# by STRAT
#abundance 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=abundance_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#biomass
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=biomass_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=richness_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file="fk_MeanRichness_ByStratumForEachYear.pdf", path="big_csv/plots")

#mean simpson 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=simpson_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#Mean ENS 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=shannon_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# by YEAR
#mean abundance 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=abundance_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean biomass 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=biomass_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) +
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness
ggplot(matrices_strat_grouped, aes(x=YEAR, y=richness_mean, group=YEAR)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT_GROUPED, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean simpson
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = simpson_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = shannon_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

```

```{r plot by strata grouped and subregion}

all_matrices_data_with_subregion = readRDS("psu_matrices_data_with_subregion_rds")

df = all_matrices_data_with_subregion %>% 
  mutate(
    STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
  group_by(SUBREGION_DOMAIN, STRAT_GROUPED, YEAR) %>%
  filter(SUBREGION_DOMAIN !="BiscBay") # 4432 x 25

#Melt dataframe so diversity indices are in a single column
  x = reshape2::melt(df, id.vars = c("YEAR", "SUBREGION_DOMAIN", "STRAT_GROUPED"), measure.vars=c("abundance_sum", "biomass_sum", "evenness","richness","simpson","shannon","func.div")) # 31024 x 5

#Summarize means and SEs by year, subregion, and variable
  x=plyr::ddply(x, c("YEAR", "SUBREGION_DOMAIN", "STRAT_GROUPED", "variable"), summarize, value.mean=mean(value), value.se=plotrix::std.error(value))

#Rename levels for figure plotting
  levels(x$variable)=c("A) Abundance", "B) Biomass", "C) Evenness", "D) Richness", "E) Simpson", "F) Shannon", "G) Functional")

#Rename regions for figure plotting
x$SUBREGION_DOMAIN=factor(x$SUBREGION_DOMAIN)
levels(x$SUBREGION_DOMAIN)=c("Upper Keys", "Middle Keys", "Lower Keys")

#Plot line graph
#HIGH RELIEF
HR = x %>% filter(STRAT_GROUPED=="HIGH_RELIEF") %>% ggplot(.,aes(x=YEAR, y=value.mean, col=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+
  geom_point(size=3)+
  geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se),width=0.1)+
   geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  facet_wrap(~variable,scales="free",ncol=2)+
  labs(title= "High Relief", x="Year", y="", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
    theme(
      strip.text=element_text(hjust = 0),
      strip.background = element_blank(),
      panel.spacing.x=unit(3, "lines"),
      legend.position=c(0.75,0.1))
HR
ggsave(file="all_indices_by_subregion_and_year_HIGH_RELIEF.pdf", HR, width=7, height=10, path="big_csv/plots")

#LINEAR REEF
LR = x %>% filter(STRAT_GROUPED=="LINEAR_REEF") %>% ggplot(.,aes(x=YEAR, y=value.mean, col=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+
  geom_point(size=3)+
  geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se),width=0.1)+
   geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  facet_wrap(~variable,scales="free",ncol=2)+
  labs(title= "Linear Reef", x="Year", y="", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
    theme(
      strip.text=element_text(hjust = 0),
      strip.background = element_blank(),
      panel.spacing.x=unit(3, "lines"),
      legend.position=c(0.75,0.1))
ggsave(file="all_indices_by_subregion_and_year_LINEAR_REEF.pdf", LR, width=7, height=10, path="big_csv/plots")

#PATCH REEF
PR = x %>% filter(STRAT_GROUPED=="PATCH_REEF") %>% ggplot(.,aes(x=YEAR, y=value.mean, col=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+
  geom_point(size=3)+
  geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se),width=0.1)+
   geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  facet_wrap(~variable,scales="free",ncol=2)+
  labs(title= "Patch Reef", x="Year", y="", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
    theme(
      strip.text=element_text(hjust = 0),
      strip.background = element_blank(),
      panel.spacing.x=unit(3, "lines"),
      legend.position=c(0.75,0.1))
ggsave(file="all_indices_by_subregion_and_year_PATCH_REEF.pdf", PR, width=7, height=10, path="big_csv/plots")
PR
```

Plots by subregions, grouped strata and years  

Group strata by: patch reef, forereef, and high relief
Subregions: UK, MK, LK

```{r Plot by grouped strata subregion and year} 

if(!file.exists("matrices_strat_grouped_with_subregion_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds") # 5238 x 32
  subregions = as.tibble(read_csv("big_csv/subregion_domains/subregion_domains_by_psu.csv")) # 5241 x 3
  
    #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR]
 subregions = subregions[!(subregions$YEAR == "2006" & 
                             subregions$PRIMARY_SAMPLE_UNIT == "602U" | 
                             subregions$YEAR == "2016" & 
                             subregions$PRIMARY_SAMPLE_UNIT == "1010U" |
                             subregions$YEAR == "2001" &
                             subregions$PRIMARY_SAMPLE_UNIT == "222U"),] #5238 x 3
  saveRDS(subregions, "subregions_rds")
  
  all_matrices_data_with_subregion = inner_join(all_matrices_data, subregions) #5,239 x 25                  
  
  saveRDS(all_matrices_data_with_subregion, "psu_matrices_data_with_subregion_rds")
  
  matrices_strat_grouped_with_subregion = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    filter(SUBREGION_DOMAIN != "BiscBay") %>% 
    group_by(SUBREGION_DOMAIN, STRAT_GROUPED, YEAR) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness, na.rm = T),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness, na.rm = T),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_strat_grouped_with_subregion, "matrices_strat_grouped_with_subregion_rds")
  } else {
    matrices_strat_grouped_with_subregion = read_rds("matrices_strat_grouped_with_subregion_rds") # 184 x 45
    }

#abundance
ab_sy_HR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="HIGH_RELIEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_year_High_Relief.pdf", path="big_csv/plots")

ab_sy_LR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="LINEAR_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_year_Linear_Reef.pdf", path="big_csv/plots")

ab_sy_PR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="PATCH_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_year_Patch_Reef.pdf", path="big_csv/plots")

#biomass
bio_sy_HR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="HIGH_RELIEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Biomass", x="Year", y="Mean biomass ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_subregion_and_year_High_Relief.pdf", path="big_csv/plots")

bio_sy_LR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="LINEAR_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Biomass", x="Year", y="Mean biomass ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_subregion_and_year_Linear_Reef.pdf", path="big_csv/plots")

bio_sy_PR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="PATCH_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Biomass", x="Year", y="Mean biomass ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_subregion_and_year_Patch_Reef.pdf", path="big_csv/plots")

#richness
rich_sy_HR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="HIGH_RELIEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Richness", x="Year", y="Mean number of effective species", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_subregion_and_year_High_Relief.pdf", path="big_csv/plots")

rich_sy_LR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="LINEAR_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Richness", x="Year", y="Mean number of effective species", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_subregion_and_year_Linear_Reef.pdf", path="big_csv/plots")

rich_sy_PR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="PATCH_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Richness", x="Year", y="Mean number of effective species", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_subregion_and_year_Patch_Reef.pdf", path="big_csv/plots")

```

Plots by subregion across years (without strata type)

```{r plot by subregion and year (no strata)}

all_matrices_data_with_subregion = read_rds("psu_matrices_data_with_subregion_rds")
  
  matrices_strat_grouped_with_subregion = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    filter(SUBREGION_DOMAIN != "BiscBay") %>% 
    group_by(YEAR, SUBREGION_DOMAIN) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness, na.rm = T),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness, na.rm = T),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  # by STRAT_GROUPED and YEAR
#abundance
ab_g= ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance (Â± SE)", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+ #("grey15", "grey45", "grey75")
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_year_subregion.pdf", path="big_csv/plots")

#biomass
bio_g= ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.1)+
  labs(title= "B) Biomass", x="Year", y="Mean biomass (Â± SE)", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_year_and_subregion.pdf", path="big_csv/plots")

#evenness
eve_g = ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=evenness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean relative evenness (Â± SE)",colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none", #right
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="evenness_by_year_and_subregion.pdf", path="big_csv/plots")

#richness
rich_g= ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.1)+
  labs(title= "D) Richness", x="Year", y="Mean effective \nnumber of species (Â± SE)", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_year_and_subregion.pdf", path="big_csv/plots")

#simpson
sim_g= ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=simpson_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.1)+
  labs(title= "E) Simpson", x="Year", y="Mean effective \nnumber of species (Â± SE)", colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="simpson_by_year_and_subregion.pdf", path="big_csv/plots")

#shannon
shan_g= ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=shannon_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.1)+
  labs(title= "F) Shannon", x="Year", y="Mean effective \nnumber of species (Â± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="shannon_by_year_and_subregion.pdf", path="big_csv/plots")

#functional
func_g= ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=func.div_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ #shape=STRAT
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean effective \nnumber of species (Â± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="functional_diversity_by_year_and_subregion.pdf", path="big_csv/plots")

#save legend
for_legend_g = ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ 
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
for_legend_g <- get_legend(for_legend_g)

for_legend_g_horiz = ggplot(matrices_strat_grouped_with_subregion,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+ 
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Subregion")+
  scale_colour_manual(labels=c("Lower Keys", "Middle Keys", "Upper Keys"), values= c("blue", "deeppink", "darkviolet"))+
    theme(
      legend.position="bottom", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_g_horiz <- get_legend(for_legend_g_horiz)

#combine multiple plots
#all plots on one page
g_g <- grid.arrange(ab_g,bio_g,eve_g,rich_g,sim_g,shan_g,func_g,for_legend_g,ncol=2)
ggsave(file="all_indices_by_year_and_grouped.pdf", g_g, width=7, height=10, path="big_csv/plots")

```

- tried using lapply, seq_along, and for( i in blank) but couldn't get it to work. Then tried melt and came close to what we want, but still need to facet by grouped strata. 

Group strata by: patch reef, forereef, and high relief
Group years by: all years combined
Subregions: UK, MK, LK

```{r Plot by subregion and grouped strat (all years combined)} 

if(!file.exists("matrices_strat_and_year_grouped_with_subregion_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds") # 5238 x 23
  subregions = readRDS("subregions_rds") # 5238 x 3
  
  all_matrices_data_with_subregion = inner_join(all_matrices_data, subregions) #5,241 x 25                  
  saveRDS(all_matrices_data_with_subregion, "psu_matrices_data_with_subregion_rds")
  
  matrices_strat_and_year_grouped = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    filter(SUBREGION_DOMAIN != "BiscBay") %>%
    group_by(SUBREGION_DOMAIN, STRAT_GROUPED) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_strat_and_year_grouped, "matrices_strat_and_year_grouped_with_subregion_rds")
  } else {
    matrices_strat_and_year_grouped = read_rds("matrices_strat_and_year_grouped_with_subregion_rds")
    }


# by STRAT_GROUPED and subregion
#abundance
ab_sub= ggplot(matrices_strat_and_year_grouped,aes(x=SUBREGION_DOMAIN,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)

geom_line(aes(group=STRAT_GROUPED),lwd=1) +
+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))

ggsave(file="abundance_by_subregion_and_strata_grouped.pdf", path="big_csv/plots")


# by STRAT_GROUPED and YEAR
#mean abundance
ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Mean Abundance", x="Year", y="Abundance of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
ggsave(file=".pdf", path="big_csv/plots")

#mean biomass
ggplot(matrices_strat_grouped,aes(x=YEAR,y=biomass_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2)+
  labs(title= "B) Mean Biomass", x="Year", y="Biomass of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
ggsave(file="biomass_by_year_strata_subregion.pdf", path="big_csv/plots")
#ggsave(file="", path="big_csv/plots")

#mean richness
ggplot(matrices_strat_grouped,aes(x=YEAR,y=richness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2)+
  labs(title= "A) Richness", x="Year", y="Effective number of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
ggsave(file="richness_by_year_strata_subregion.pdf", path="big_csv/plots")

#mean simpson
ggplot(matrices_strat_grouped,aes(x=YEAR,y=simpson_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2)+
  labs(title= "A) Simpson", x="Year", y="Effective number of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
 
#mean shannon
ggplot(matrices_strat_grouped,aes(x=YEAR,y=shannon_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2)+
  labs(title= "A) Simpson", x="Year", y="Effective number of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))

# by STRAT
#abundance 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=abundance_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
ggsave(file=".pdf", path="big_csv/plots")

#biomass
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=biomass_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=richness_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file="fk_MeanRichness_ByStratumForEachYear.pdf", path="big_csv/plots")

#mean simpson 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=simpson_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=shannon_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# by YEAR
#mean abundance 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=abundance_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean biomass 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=biomass_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) +
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness
ggplot(matrices_strat_grouped, aes(x=YEAR, y=richness_mean, group=YEAR)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT_GROUPED, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean simpson
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = simpson_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = shannon_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

```

```{r plots by PROT and year}

if(!file.exists("matrices_strat_grouped_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds")
  
  matrices_ntmr = all_matrices_data %>% 
    group_by(YEAR, PROT) %>% #add subregion later 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_ntmr, "Data/matrices_ntmr_rds")
  
  write_csv(matrices_ntmr, "matrices_ntmr.csv")
  
  }else{
  matrices_ntmr = read_rds("matrices_ntmr_rds")
  }

# by YEAR and PROT
#mean abundance
ab_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
    #plot.caption = element_text(size=10))
ggsave(file="abundance_by_year_PROT.pdf", path="Figures")

#biomass
bio_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=biomass_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  labs(title= "B) Biomass", x="Year", y="Mean biomass (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="biomass_by_year_PROT.pdf", path="big_csv/plots")

# evenness
eve_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=evenness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean relative evenness (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="evenness_by_year_PROT.pdf", path="Figures")

#richness
rich_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=richness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  labs(title= "D) Richness", x="Year", y="Mean effective \nnumber of species (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="richness_by_year_PROT.pdf", path="Figures")

#simpson
simp_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=simpson_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=simpson_mean+simpson_se,ymin=simpson_mean-simpson_se),width=0.1)+
  labs(title= "E) Simpson", x="Year", y="Mean effective \nnumber of species (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="simpson_diversity_by_year_PROT.pdf", path="Figures")

# shannon
shan_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=shannon_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=shannon_mean+shannon_se,ymin=shannon_mean-shannon_se),width=0.1)+
  labs(title= "F) Shannon", x="Year", y="Mean effective \nnumber of species (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="shannon_diversity_by_year_PROT.pdf", path="Figures")

# functional
func_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=func.div_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean effective \nnumber of species (Â± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(limits = c(1999, 2018), 
                     breaks = c(1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012, 2013, 2014, 2015,2016,2017, 2018),
                     labels=c("","2000","","2002","","2004","","2006","","2008","","2010","","2012","","2014","","2016","","2018"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="functional_diversity_by_year_PROT.pdf", path="Figures")

#save legend
for_legend_prot_vert = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=factor(PROT)),lwd=1) +
  geom_point(size=3) +
  labs(colour = "")+
  scale_colour_manual(labels=c("Protected", "Not Protected"), values= c("red", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))

legend_prot_vert <- get_legend(for_legend_prot_vert)

for_legend_prot_horiz = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=factor(PROT)),lwd=1) +
  geom_point(size=3) +
  labs(colour = "")+
  scale_colour_manual(labels=c("Protected", "Not Protected"), values= c("red", "blue"))+
    theme(
      legend.position="bottom", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_prot_horiz <- get_legend(for_legend_prot_horiz)

#combine multiple plots
#all plots on one page
g_prot <- grid.arrange(ab_prot,bio_prot,eve_prot,rich_prot,simp_prot,shan_prot,func_prot,legend_prot_vert,ncol=2)

ggsave(file="all_indices_by_year_and_prot.pdf", g_prot, width=7, height=10, path="big_csv/plots")

#plots on two pages - letters in plot titles will need to be changed so they make sense on two pages (i.e., A-C and A-D)
g3 <- grid.arrange(ab_gs,bio_gs,eve_gs,legend_gs_vert,ncol=2)
ggsave(file="ab_bio_eve_by_year_and_strata_grouped.pdf", g3, width=7, height=5, path="big_csv/plots")

g4 <- grid.arrange(arrangeGrob(rich_gs,sim_gs,ncol=2),arrangeGrob(shan_gs,func_gs,ncol=2),legend_gs_horiz,nrow=3,heights=c(2,2,.4))
ggsave(file="rich_shan_sim_func_by_year_and_strata_grouped.pdf", g4, width=7, height=6, path="big_csv/plots")

rich_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, richness_mean) %>%
  spread(PROT, richness_mean) %>%
  mutate(ratio = `1` - `0`)
mean(rich_ntmr$ratio) #4.093574

abun_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, abundance_mean) %>%
  spread(PROT, abundance_mean) %>%
  mutate(ratio = `1` - `0`)
mean(abun_ntmr$ratio) #99.41827

bio_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, biomass_mean) %>%
  spread(PROT, biomass_mean) %>%
  mutate(ratio = `1` - `0`)
mean(bio_ntmr$ratio) #13.52065

eve_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, evenness_mean) %>%
  spread(PROT, evenness_mean) %>%
  mutate(ratio = `1` - `0`)
mean(eve_ntmr$ratio) #0.004180086

sim_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, simpson_mean) %>%
  spread(PROT, simpson_mean) %>%
  mutate(ratio = `1` - `0`)
mean(sim_ntmr$ratio) #0.5490365

shan_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, shannon_mean) %>%
  spread(PROT, shannon_mean) %>%
  mutate(ratio = `1` - `0`)
mean(shan_ntmr$ratio) #0.9409276

func_ntmr = matrices_ntmr %>%
  select(YEAR, PROT, func.div_mean) %>%
  spread(PROT, func.div_mean) %>%
  mutate(ratio = `1` - `0`)
mean(func_ntmr$ratio) #0.1005665

```

```{r percent grouped strat in NTMR}

all_matrices_data = read_rds("psu_matrices_data_rds")

matrices_strat_grouped = all_matrices_data %>% 
    mutate(
      STRAT_GROUPED = #group strata 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) 

#of the 5,270 sampling events, 1416 occured in MPA (26.87% of the sampling events)
percent_ntmr = matrices_strat_grouped %>% 
  filter(PROT != 0) %>% #1416 in MPA 
  filter(STRAT_GROUPED == "HIGH_RELIEF") #446 
#(446/1416)*100 #31.50%

percent_ntmr = matrices_strat_grouped %>% #5238
  filter(PROT != 0) %>% #1416 in MPA 
  filter(STRAT_GROUPED == "PATCH_REEF") #254
#(254/1416)*100 = 17.94%

percent_ntmr = matrices_strat_grouped %>% #5238
  filter(PROT != 0) %>% #1416
  filter(STRAT_GROUPED == "LINEAR_REEF") #716
#(716/1416)*100  50.56%

```

## GAM and Partial Deviances 

Build GAM model with temporal, spatial, environmental and management variables 

$y_i = \alpha + f_1(X_1i) + f_2(X_2i) + g_1(X_3i) + g_2(X_4i) + \epsilon_i$
$y_i = \alpha + f_1 (YEAR)+ f_2(PROT) + g_1(LONG, LAT)* YEAR + g_2(STRAT) + \epsilon_i$

$y_i$ is the calculated diversity for station i (response variable)
$\alpha$ is the intercept that scales the model prediction to the appropriate level of the response
$f_1 (X_1i)$ is a smoother
$g_1 (X_1i)$ is nonparametric smoother for covariates strata
$\epsilon_i$ the residual error

Temporal variables:
- YEAR: Year (categorical factor)

Spatial variables:
- latitude and longitude (continuous covariate)

Environmental variables: 
- strata (categorical factor)
- bottom depth (continuous covariate)

Management variable:
- PROT: No take marine reserve  (categorical factor)

Conitinuous covariates: modeled using non-parametric smoothing 
- thin plate regression splines with shrinkage terms (Ciannelli et al., 2008)

Categorical factors: models parametrically to determine their mean effect sizes (Zurr et al., 2009)

Fit GAM to each index separately. 

- To assess the explanatory power of each variable calculate the partial deviances by sequentially removing suites of predictors from the full gam model corresponding to indicators of space, time, environment, or management. 

- Repeat this for all possible permutations 

- Average the deviances for all models in which the predictor appeared and calculate the standard error 

- the partial deviances are the proportion of total explained deviance of the model uniquely explained by space, time, environment or management, accounting for the other predictors in the model. 

Modified from [https://stat.ethz.ch/pipermail/r-help/2011-November/295324.html]

- look into mixed effect model GAMM 
- ran GAMM with each combination of variables, weight of AIC

```{r richness GAM}

if(!file.exists("richness_prop.deviance_rds","richness_model_summary_rds")){

# 1. Read in data and remove years (optional)
all_matrices_data = read_csv("Data/RVC_biodiversity_calculated.csv")

gam_data = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, evenness, richness, simpson, shannon, func.div)

#as.data.frame(data)

richness.partial.deviance.list = for(j in names(gam_data[,11])) { 
  
    #Build full model and null model based on (transformed) response variable
    if(j=="richness") {
      fullmod = gam(formula(paste(j,"~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
      } 
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  richness_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Environment","Management"),
    rich_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    rich_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  richness_model_summary = summary(fullmod)
  
  saveRDS(richness_prop.deviance, "richness_prop.deviance_rds")
  saveRDS(richness_model_summary, "richness_model_summary_rds")
  
  } else{
  richness_prop.deviance = read_rds("richness_prop.deviance_rds")
  richness_model_summary = read_rds("richness_model_summary_rds")
}
  
```

```{r abun GAM}

if(!file.exists("abun_prop.deviance_rds","abun_model_summary_rds")){
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  abun_partial.deviance.list = for(j in names(gam_data[,8])) { 
    
    #Build full model and null model based on (transformed) response variable
    fullmod = gam(formula(paste("log(",j,")~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES, by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), data=gam_data)
    nullmod = gam(formula(paste("log(",j,")~1")), data=gam_data)
    
    #Set up empty vectors for deviances
    time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()
    
    #Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 
    
    #time deviances 
    
    ###Sequence 1: time->space->mangement->environment 
    
    time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
      deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)
    
    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
      deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
      deviance(nullmod)
    
    ###Sequence 10: space->environment->time->mangement 
    
    space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
      deviance(nullmod)
    
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
      deviance(nullmod)
    
    ###Sequence 12: space->mangement->environment->time
    
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #ENVIRONMENT
    
    ###Sequence 13: environment->time->space->management 
    
    env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
      deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    # MANAGEMENT 
    
    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Squence 24: management->time->environment->space
    
    mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
  }
  #Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
  
  #Bind results into data.frame
  abun_prop.deviance=data.frame(
    Diversity=paste(j),
    Predictor=c("All","Space","Time","Environment","Management"),
    abun_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    abun_partial_deviance.SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  abun_model_summary = summary(fullmod)
  
  saveRDS(abun_prop.deviance, "abun_prop.deviance_rds")
  saveRDS(abun_model_summary, "abun_model_summary_rds")
  
}else{
  abun_prop.deviance = read_rds("abun_prop.deviance_rds")
  abun_model_summary = read_rds("abun_model_summary_rds")
}

```

```{r biomass GAM}

if(!file.exists("bio_prop.deviance_rds", "bio_model_summary_rds")){
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  bio_partial.deviance.list = for(j in names(gam_data[,9])) { 
    
    #Build full model and null model based on (transformed) response variable
    fullmod = gam(formula(paste("log(",j,")~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES, by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), data=gam_data)
    nullmod = gam(formula(paste("log(",j,")~1")), data=gam_data)
    
    #Set up empty vectors for deviances
    time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()
    
    #Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 
    
    #time deviances 
    
    ###Sequence 1: time->space->mangement->environment 
    
    time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
      deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)
    
    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
      deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
      deviance(nullmod)
    
    ###Sequence 10: space->environment->time->mangement 
    
    space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
      deviance(nullmod)
    
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
      deviance(nullmod)
    
    ###Sequence 12: space->mangement->environment->time
    
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #ENVIRONMENT
    
    ###Sequence 13: environment->time->space->management 
    
    env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
      deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    # MANAGEMENT 
    
    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Squence 24: management->time->environment->space
    
    mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
  }
  #Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
  
  #Bind results into data.frame
  bio_prop.deviance=data.frame(
    Diversity=paste(j),
    Predictor=c("All","Space","Time","Environment","Management"),
    bio_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    bio_partial_deviance.SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  bio_model_summary = summary(fullmod)
  
  saveRDS(bio_prop.deviance, "bio_prop.deviance_rds")
  saveRDS(bio_model_summary, "bio_model_summary_rds")
} else{
  bio_prop.deviance = read_rds("bio_prop.deviance_rds")
  bio_model_summary = read_rds("bio_model_summary_rds")
}
  
```

```{r evenness GAM}

if(!file.exists("even_prop.deviance_rds","even_model_summary_rds")){

gam_data = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)

even_partial_deviance_list = for(j in names(gam_data[,10])) { 
  
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste("asin(sqrt(",j,"))~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), data=gam_data)
      nullmod = gam(formula(paste("asin(sqrt(",j,"))~1")), data=gam_data)
      
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  even_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Environment","Management"),
    even_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    even_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  even_model_summary = summary(fullmod)
  
  saveRDS(even_prop.deviance, "even_prop.deviance_rds")
  saveRDS(even_model_summary, "even_model_summary_rds")

  }else{
    even_partial_deviance = read_rds("even_prop.deviance_rds")
    even_model_summary = ead_rds("even_model_summary_rds")
}
  
```

```{r simpson GAM}

if(!file.exists("simp_prop.deviance_rds","simp_model_summary_rds")){
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  simp_partial_deviance_list = for(j in names(gam_data[,12])) { 
    
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste(j,"~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
    
    #Set up empty vectors for deviances
    time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()
    
    #Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 
    
    #time deviances 
    
    ###Sequence 1: time->space->mangement->environment 
    
    time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
      deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)
    
    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
      deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
      deviance(nullmod)
    
    ###Sequence 10: space->environment->time->mangement 
    
    space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
      deviance(nullmod)
    
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
      deviance(nullmod)
    
    ###Sequence 12: space->mangement->environment->time
    
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #ENVIRONMENT
    
    ###Sequence 13: environment->time->space->management 
    
    env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
      deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    # MANAGEMENT 
    
    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Squence 24: management->time->environment->space
    
    mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
  }
  
  #Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
  
  #Bind results into data.frame
  simp_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Environment","Management"),
    simp_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    simp_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  simp_model_summary = summary(fullmod)
  
  saveRDS(simp_prop.deviance,"simp_prop.deviance_rds")
  saveRDS(simp_model_summary, "simp_model_summary_rds")
  
} else{
  simp_prop.deviance = read_rds("simp_prop.deviance_rds")
  simp_model_summary = read_rds("simp_model_summary_rds")
}
  
```

```{r shannon GAM}

if(!file.exists("shan_prop.deviance_rds","shan_model_summary_rds")){
  
gam_data = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)

shan_partial_deviance_list = for(j in names(gam_data[,13])) { 
  
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste(j,"~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
       
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  shan_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Environment","Management"),
    shan_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    shan_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  shan_model_summary = summary(fullmod)
  
  saveRDS(shan_prop.deviance, "shan_prop.deviance_rds")
  saveRDS(shan_model_summary, "shan_model_summary_rds")
  
}else{
  shan_prop.deviance = read_rds("shan_prop.deviance_rds")
  shan_model_summary = read_rds("shan_model_summary_rds")   
}
  
```

```{r functional GAM}

if(!file.exists("func_prop.deviance","func_model_summary_rds")){
  
gam_data = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)

func_partial_deviance_list = for(j in names(gam_data[,14])) { 
  
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste(j,"~YEAR+STRAT+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  func_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Environment","Management"),
    func_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    func_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  func_model_summary = summary(fullmod)
  
  saveRDS(func_prop.deviance, "func_prop.deviance_rds")
  saveRDS(func_model_summary, "func_model_summary_rds")
  
}else{
  func_prop.deviance = read_rds("func_prop.deviance_rds")
  func_model_summary = read_rds("func_model_summary_rds")
}
  
```

```{r bind gam}

library(data.table)

setnames(abun_prop.deviance, old=c("Diversity", "Predictor","abun_partial_deviance","abun_partial_deviance.SE"), new=c("Diversity", "Predictor","Partial_Deviance","Partial_Deviance_SE"))

setnames(bio_prop.deviance, old=c("Diversity", "Predictor", "bio_partial_deviance","bio_partial_deviance.SE"), new=c("Diversity", "Predictor","Partial_Deviance","Partial_Deviance_SE"))
 
setnames(even_prop.deviance, old=c("diversity", "predictor", "even_partial_deviance","even_partial_deviance_SE"), new=c("Diversity", "Predictor","Partial_Deviance","Partial_Deviance_SE"))

setnames(richness_prop.deviance, old=c("diversity","predictor","rich_partial_deviance", "rich_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

setnames(simp_prop.deviance, old=c("diversity","predictor","simp_partial_deviance", "simp_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

setnames(shan_prop.deviance, old=c("diversity","predictor","shan_partial_deviance", "shan_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

setnames(func_prop.deviance, old=c("diversity","predictor","func_partial_deviance", "func_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

partial_deviance_list = rbind(abun_prop.deviance, bio_prop.deviance, even_prop.deviance, richness_prop.deviance, simp_prop.deviance, shan_prop.deviance, func_prop.deviance)

partial_deviance_list = partial_deviance_list %>%
    mutate(Percent_Partial_Deviance = Partial_Deviance*100)

write_csv(partial_deviance_list, "partial_deviance_list.csv")

library(car)

partial_deviance_list$Diversity = car::recode(partial_deviance_list$Diversity, "'abundance_sum'='Abundance'; 'biomass_sum'='Biomass'; 'evenness'='Evenness'; 'richness'='Richness'; 'simpson'='Simpson'; 'shannon'='Shannon'; 'func.div'='Functional'")

```

```{r deviance barplot}

partial_deviance_list = read_csv("partial_deviance_list.csv")

partial_deviance_data=subset(partial_deviance_list, Predictor!="All")

diversity_order = c("Abundance", "Biomass", "Evenness","Richness", "Simpson", "Shannon", "Functional")

partial_deviance_data= partial_deviance_list %>%
  filter(Predictor != "All") %>%
  mutate(Diversity = factor(Diversity, levels=diversity_order)) 
         
partial_deviance_explained = ggplot(partial_deviance_data,aes(x= Diversity, y= Partial_Deviance*100, fill=Predictor))+
    geom_bar(position="dodge", color="black", stat = "identity")+
    geom_errorbar(aes(max=(Partial_Deviance+Partial_Deviance_SE)*100,
                      min=(Partial_Deviance-Partial_Deviance_SE)*100),
                  width=0.3,size=0.6, position=position_dodge(width=0.9))+
    labs(x="", y="Total Percent \nDeviance Explained")+
    #scale_fill_manual(values=c("grey50","grey80","white"))+
    theme_bw(base_size=18)+
    theme(
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      legend.position="bottom",
      axis.text = element_text(color="black"),
      legend.title=element_blank())

ggsave(file="partial_deviance_explained.pdf", partial_deviance_explained, width=8, height=4, path="big_csv/plots")

```

### Kruskal-Wallis and Dunn test 

```{r playing}

compare = mean_indices %>% 
  select(simpson_mean, func.div_mean, YEAR, STRAT) %>%
  mutate(dif = (func.div_mean/simpson_mean)) 

x = mean(compare$dif)
(1-x)/x

#simpson diversity is on average 2 times greater than functional diversity 

all_matrices_data_with_subregion = read_rds("psu_matrices_data_with_subregion_rds")
  
matrices_subregion = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    filter(SUBREGION_DOMAIN != "BiscBay") %>% 
    group_by(SUBREGION_DOMAIN) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness, na.rm = T),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness, na.rm = T),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
matrices_sr = matrices_subregion %>%
  select(SUBREGION_DOMAIN,abundance_mean,biomass_mean,evenness_mean, richness_mean,simpson_mean, shannon_mean, func.div_mean) %>%
  t()

stats_all_matrices_data

strata_rich_mean = stats_all_matrices_data %>% 
  select(richness_mean, STRAT, YEAR) %>%
  group_by(STRAT) %>%
  spread(STRAT, richness_mean, fill = 0) %>%
  summarize(
    FDLR_mean = mean(FDLR),
    FMLR_mean = mean(FMLR),
    FSLR_mean = mean(FSLR),
    HRRF_mean = mean(HRRF),
    INPR_mean = mean(INPR),
    MCPPR_mean = mean(MCPR),
    OFPR_mean = mean(OFPR)) 

strata_simp_mean = stats_all_matrices_data %>% 
  select(simpson_mean, STRAT, YEAR) %>%
  group_by(STRAT) %>%
  spread(STRAT, simpson_mean, fill = 0) %>%
  summarize(
    FDLR_mean = mean(FDLR),
    FMLR_mean = mean(FMLR),
    FSLR_mean = mean(FSLR),
    HRRF_mean = mean(HRRF),
    INPR_mean = mean(INPR),
    MCPPR_mean = mean(MCPR),
    OFPR_mean = mean(OFPR)) %>%
  t() 

strata_shan_mean = stats_all_matrices_data %>% 
  select(shannon_mean, STRAT, YEAR) %>%
  group_by(STRAT) %>%
  spread(STRAT, shannon_mean, fill = 0) %>%
  summarize(
    FDLR_mean = mean(FDLR),
    FMLR_mean = mean(FMLR),
    FSLR_mean = mean(FSLR),
    HRRF_mean = mean(HRRF),
    INPR_mean = mean(INPR),
    MCPPR_mean = mean(MCPR),
    OFPR_mean = mean(OFPR)) %>%
  t() 

```

```{r KW prot}
### KRUSKAL TEST WITH PROT 
#comparse the sums of ranks 
#KW assumes all of your samples come from the same type of distribution
# if p-value is less than 0.05 than we reject the null hypothesis that there is no dfference between the means and conclude that a significant difference does exist. If p-value is >0.05 than we cannot conclude that a significant difference exists 

all_matrices_data = read_rds("psu_matrices_data_rds")

all_matrices_data$PROT = factor(all_matrices_data$PROT, levels=c("0","1"))
levels(all_matrices_data$PROT)

#abundance  
kruskal.test(all_matrices_data$abundance_sum~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 83.908, df = 1, p-value < 2.2e-16

#Dunn test
dt_abun_prot = dunnTest(abundance_sum ~ PROT, data=all_matrices_data)
dt_abundance_prot = dt_abun_prot$res

#biomass 
kruskal.test(all_matrices_data$biomass_sum~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 172.69, df = 1, p-value < 2.2e-16

#evenness - NOT SIGNIFICANT 
kruskal.test(all_matrices_data$evenness~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 1.2309, df = 1, p-value = 0.2672

#richness 
kruskal.test(all_matrices_data$richness~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 109.16, df = 1, p-value < 2.2e-16

#Simpson 
kruskal.test(all_matrices_data$simpson~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 22.569, df = 1, p-value = 2.027e-06

#Shannon 
kruskal.test(all_matrices_data$shannon~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 29.719, df = 1, p-value = 4.994e-08

#FD 
kruskal.test(all_matrices_data$func.div~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 15.991, df = 1, p-value = 6.365e-05

```

```{r KW test strata}

#### KRUSKAL TEST WITH STRATA 

all_matrices_data = read_rds("psu_matrices_data_rds")

all_matrices_data$STRAT = factor(all_matrices_data$STRAT, levels=c("FMLR", "FSLR", "HRRF", "OFPR", "MCPR", "INPR", "FDLR"))
levels(all_matrices_data$STRAT)

all_matrices_data$STRAT = as.factor(all_matrices_data$STRAT)

#abundance strata 
kt_abun_strat = kruskal.test(all_matrices_data$abundance_sum~all_matrices_data$STRAT)
#Kruskal-Wallis chi-squared = 663.25, df = 6, p-value < 2.2e-16

dt_abun_strat = dunnTest(abundance_sum~STRAT, data=all_matrices_data)
dt_abundance_strat = dt_abun_strat$res

cldList(P.adj~Comparison,
        data = dt_abundance_strat,
        threshold = 0.05)
#FDLR = HRRF 
#FMLR = OFPR 
#FSLR = MCPR 
#MCPR = INPR 

#biomass strata 
kt_bio_strat = kruskal.test(all_matrices_data$biomass_sum~all_matrices_data$STRAT)
#Kruskal-Wallis chi-squared = 655.02, df = 6, p-value < 2.2e-16

dt_bio_strat = dunnTest(biomass_sum~STRAT, data=all_matrices_data)
dt_biomass_strat = dt_bio_strat$res

cldList(P.adj~Comparison,
        data = dt_biomass_strat,
        threshold = 0.05)
#FMLR = MCPR 
#INPR = FMLR 
#INPR = OFPR 
#INPR = MCPR 

#evenness strata 
kruskal.test(all_matrices_data$evenness~all_matrices_data$STRAT)
#Kruskal-Wallis chi-squared = 324.62, df = 6, p-value < 2.2e-16

dt_eve_strat = dunnTest(evenness~STRAT, data=all_matrices_data)
dt_evennes_strat = dt_eve_strat$res

cldList(P.adj~Comparison,
        data = dt_evennes_strat,
        threshold = 0.05)
#FMLR = HRRF 
#FSLR = MCPR 
#INPR = HRRF 
#INPR = FMLR 
#INPR = MCPR 
#MCPR = INPR 

#richness strata 
kruskal.test(all_matrices_data$richness~all_matrices_data$STRAT)
#Kruskal-Wallis chi-squared = 1192.5, df = 6, p-value < 2.2e-16

dt_rich_strat = dunnTest(richness~STRAT, data=all_matrices_data)
dt_richnnes_strat = dt_rich_strat$res

cldList(P.adj~Comparison,
        data = dt_richnnes_strat,
        threshold = 0.05)
#FMLR = OFPR 

#Simpson strata
kruskal.test(all_matrices_data$simpson~all_matrices_data$STRAT)
#Kruskal-Wallis chi-squared = 352.49, df = 6, p-value < 2.2e-16

dt_simp_strat = dunnTest(simpson~STRAT, data=all_matrices_data)
dt_simpson_strat = dt_simp_strat$res

cldList(P.adj~Comparison,
        data = dt_simpson_strat,
        threshold = 0.05)
#FMLR = FSLR 
#FDLR = INPR 
#HRRF = OFPR 

#Shannon strata
kruskal.test(all_matrices_data$shannon~all_matrices_data$STRAT)
#ruskal-Wallis chi-squared = 446.17, df = 6, p-value < 2.2e-16

dt_shan_strat = dunnTest(shannon~STRAT, data=all_matrices_data)
dt_shannon_strat = dt_shan_strat$res

cldList(P.adj~Comparison,
        data = dt_shannon_strat,
        threshold = 0.05)
#FDLR = FSLR 
#FMLR = MCPR 

#FD strata  
kruskal.test(all_matrices_data$func.div~all_matrices_data$STRAT)
#Kruskal-Wallis chi-squared = 663.1, df = 6, p-value < 2.2e-16

dt_fd_strat = dunnTest(func.div~STRAT, data=all_matrices_data)
dt_functional_strat = dt_fd_strat$res

cldList(P.adj~Comparison,
        data = dt_functional_strat,
        threshold = 0.05)
#FDLR = HRRF 
#FMLR = INPR 
#MCPR = OFPR 

DunnTest_all = cbind(dt_abundance_strat, dt_biomass_strat, dt_evennes_strat, dt_richnnes_strat, dt_simpson_strat, dt_shannon_strat, dt_functional_strat)

write_csv(DunnTest_all, "DunnTest_all.csv")

```

```{r KW subregion}

matrices_subregion_kt = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    filter(SUBREGION_DOMAIN != "BiscBay") %>% 
    group_by(SUBREGION_DOMAIN)

#Kruskal-Wallis test 
#Dependent variables: where y1 is numeric and A is a factor 

matrices_subregion_kt$SUBREGION_DOMAIN = factor(matrices_subregion_kt$SUBREGION_DOMAIN, levels=c("Lower","Middle","Upper"))

#abundance 
kt_abun_sr = kruskal.test(matrices_subregion_kt$abundance_sum~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 17.443, df = 2, p-value = 0.000163

#Dunn test
library(FSA)
dt_abun_sr = dunnTest(abundance_sum~SUBREGION_DOMAIN, data=matrices_subregion_kt)
dt_abundance_sr = dt_abun_sr$res

library(rcompanion)
cldList(P.adj~Comparison,
        data = dt_abundance_sr,
        threshold = 0.05)
#LK = UK

#biomass
kt_bio_sr = kruskal.test(matrices_subregion_kt$biomass_sum~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 28.286, df = 2, p-value = 7.206e-07

dt_bio_sr = dunnTest(biomass_sum~SUBREGION_DOMAIN, data=matrices_subregion_kt)
dt_biomass_sr = dt_bio_sr$res

#Compact letter display  
cldList(P.adj~Comparison,
        data = dt_biomass_sr,
        threshold = 0.05)
#LK, UK, & MK are all significantly different 

#evenness
kt_even_sr = kruskal.test(matrices_subregion_kt$evenness~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 17.196, df = 2, p-value = 0.0001845

#Dunn Test 
dt_even_sr = dunnTest(evenness~SUBREGION_DOMAIN, data=matrices_subregion_kt)
dt_evenness_sr = dt_even_sr$res

cldList(P.adj~Comparison,
        data = dt_evenness_sr,
        threshold = 0.05)
#LK = UK

#richness - NOT SIGNIFICANTLY DIFFERENT BY SUBREGION
kt_rich_sr = kruskal.test(matrices_subregion_kt$richness~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 0.20689, df = 2, p-value = 0.9017

#simpson
kt_simp_sr= kruskal.test(matrices_subregion_kt$simpson~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 15.834, df = 2, p-value = 0.0003646

dt_simp_sr = dunnTest(simpson~SUBREGION_DOMAIN, data=matrices_subregion_kt)
dt_simpson_sr = dt_simp_sr$res

cldList(P.adj~Comparison,
        data = dt_simpson_sr,
        threshold = 0.05)
#LK = UK

#shannon
kt_shan_sr = kruskal.test(matrices_subregion_kt$shannon~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 24.915, df = 2, p-value = 3.889e-06

dt_shan_sr = dunnTest(shannon~SUBREGION_DOMAIN, data=matrices_subregion_kt)
dt_shannon_sr = dt_shan_sr$res

cldList(P.adj~Comparison,
        data = dt_shannon_sr,
        threshold = 0.05)
#LK = UK

#fd
kt_fd_sr = kruskal.test(matrices_subregion_kt$func.div~matrices_subregion_kt$SUBREGION_DOMAIN)
#Kruskal-Wallis chi-squared = 15.587, df = 2, p-value = 0.0004124

dt_fd_sr = dunnTest(func.div~SUBREGION_DOMAIN, data=matrices_subregion_kt)
dt_functional_sr = dt_fd_sr$res

#compact letter display 
cldList(P.adj ~ Comparison,
        data = dt_functional_sr,
        threshold = 0.05)
#MK = UK 

#groups sharing a letter not significantly different (alpha = 0.05)

DunnTest_all_subregion = cbind(dt_abundance_sr, dt_biomass_sr, dt_evenness_sr, dt_richness_sr, dt_simpson_sr, dt_shannon_sr, dt_functional_sr)

write_csv(DunnTest_all_subregion, "DunnTest_all_subregion.csv")

```

```{r KW year}

all_matrices_data = read_rds("psu_matrices_data_rds")

all_matrices_data$YEAR = factor(all_matrices_data$YEAR, levels=c("1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2014", "2016"))

#abundance 
kt_abun_year = kruskal.test(all_matrices_data$abundance_sum~all_matrices_data$YEAR)
#Kruskal-Wallis chi-squared = 280.85, df = 15, p-value < 2.2e-16

dt_abun_year = dunnTest(abundance_sum~YEAR, data=all_matrices_data)
dt_abundance_year = dt_abun_year$res

cldList(P.adj~Comparison,
        data = dt_abundance_year,
        threshold = 0.05)

kt_simp_year = kruskal.test(all_matrices_data$simpson~all_matrices_data$YEAR)

dt_simp_year = dunnTest(simpson~YEAR, data=all_matrices_data)
dt_simpson_year = dt_simp_year$res

cldList(P.adj~Comparison,
        data = dt_simpson_year,
        threshold = 0.05)
```

### Lionfish abundance and biomass

```{r lionfish}

  psu_fk_abun <- read_csv("big_csv/abundance_psu/psu_fk_abun.csv",
                          col_types = cols(protected_status = col_character()))
  #dim(psu_fk_abun) #3,643,306 x 10

  lionfish_abun = psu_fk_abun %>%
    filter(stringr::str_detect(protected_status, 'all')) %>%
    filter(SPECIES_CD == "PTE VOLI") %>%
    group_by(YEAR, STRAT,PRIMARY_SAMPLE_UNIT) %>%
    summarize(abundance_sum = sum(abundance)) %>%
    filter(!abundance_sum == "0") 
  
  lionfish_abun_year = lionfish_abun %>%
    group_by(YEAR) %>%
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum), 
      abundance_total = sum(abundance_sum))
    
  lionfish = ggplot(lionfish_abun_year, aes(x = YEAR, y = abundance_total))+
    geom_line(lwd=1) +
    geom_point(size=3)+ 
    labs(title= "Lionfish Abundance", x="Year", y="Total Abundance (number of individuals)")+
    scale_x_continuous(limits = c(2010, 2016), breaks = c(2010, 2012, 2014, 2016), labels=c("2010","2012","2014","2016"))+
  #scale_y_continuous(limits= c(200,1000))+
  theme_bw()+
  theme(
      legend.position="none", #"none", "right",c(0.8,0.68),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
  
  ggsave(file="lionfish_abun.pdf", lionfish, width=4, height=4, path="big_csv/plots")
    
  #psu_fk_bio <- read_csv('big_csv/biomass_psu/psu_fk_biomass.csv', col_types = cols( protected_status = col_character())) 
    #dim(psu_fk_bio) 3,429,476*10

  # lionfish_bio = psu_fk_bio %>%
  #   filter(stringr::str_detect(protected_status, 'all'))%>%
  #   filter(SPECIES_CD == "PTE VOLI") %>%
  #   group_by(YEAR, STRAT,PRIMARY_SAMPLE_UNIT) %>%
  #   summarize(biomass_sum = sum(biomass)) %>%
  #   filter(!biomass_sum == "0") 
  # 
  # lionfish_bio = lionfish_bio %>%
  #   group_by(YEAR) %>%
  #   summarize(
  #     biomass_mean = mean(biomass_sum),
  #     biomass_n = length(biomass_sum),
  #     biomass_sd = sd(biomass_sum),
  #     biomass_se = biomass_sd / sqrt(biomass_n),
  #     biomass_min = min(biomass_sum),
  #     biomass_max = max(biomass_sum))
```

Hurricane disturbance in 2004 and 2005 

```{r hurricane disturbance}

all_matrices_data = read_rds("psu_matrices_data_rds")

hurricane = all_matrices_data[(all_matrices_data$YEAR == "2004" |
                               all_matrices_data$YEAR == "2005" |
                               all_matrices_data$YEAR == "2006" |
                                 all_matrices_data$YEAR == "2007"),]
  
hurricane_dist = hurricane %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT, abundance_sum, biomass_sum, evenness,simpson, shannon, richness, func.div) %>%
  group_by(YEAR) %>%
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))

hurricane_dist = hurricane_dist %>%
  select(YEAR, abundance_mean, biomass_mean, evenness_mean, richness_mean, simpson_mean, shannon_mean, func.div_mean)

#YEAR abundance_mean biomass_mean evenness_mean richness_mean simpson_mean
#  2004       448.1831     26.26251     0.5704466      42.78740     9.041081
#  2005       325.1630     20.74618     0.5797596      35.78516     8.313524
#  2006       308.6095     12.28805     0.5618082      34.94495     8.008290
#  2007       347.8530     17.91183     0.5775348      40.53312     8.849544

#abundance 
#decreased 2004 - 2006
#(1-(308.6095/448.1831))*100 = 31.14% 
#increased 2006 to 2007
#(1-(308.6095/347.8530))*100 = 11.28163

#biomass 
#decreased 2004 - 2006
#(1-(12.28805/26.26251))*100 = 53.21% 
#increased 2006 to 2007
#(1-(12.28805/17.91183))*100 = 31.39702

#evenness 
#decreased 2004 - 2006
#(1-(0.5618082/0.5704466))*100 = 1.5%
#increased 2006 to 2007
#(1-(0.5618082/0.5775348))*100 = 2.723057

#richness 
#decreased 2004 - 2006
#(1-(34.94495/42.78740))*100 = 18.32%
#increased 2006 to 2007
#(1-(34.94495/40.53312))*100 = 13.78668

#simpson 
#decreased 2004 - 2006
#(1-(8.008290/9.041081))*100 = 11.42%
#increased 2006 to 2007
#(1-(8.008290/8.849544))*100 = 9.506185

#shannon 
#decreased 2004 - 2006
#(1-(12.94369/14.96688))*100 = 13.5%
#increased 2006 to 2007
#(1-(12.94369/14.37536))*100 = 9.959194

#functional 
#decreased 2004 - 2006
#(1-(2.516593/2.743986))*100 = 8.2%
#increased 2006 to 2007
#(1-(2.516593/2.660305))*100 = 5.402087

cold_event = all_matrices_data[(all_matrices_data$YEAR == "2009" |
                                all_matrices_data$YEAR == "2010" |
                                all_matrices_data$YEAR == "2011"),]
  
cold_event2010 = cold_event %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT, abundance_sum, biomass_sum, evenness,simpson, shannon, richness, func.div) %>%
  group_by(YEAR) %>%
    summarize(
      abundance_mean = mean(abundance_sum),
      biomass_mean = mean(biomass_sum),
      evenness_mean = mean(evenness),
      richness_mean = mean(richness),
      simpson_mean = mean(simpson),
      shannon_mean = mean(shannon),
      func.div_mean = mean(func.div))

#YEAR abundance_mean biomass_mean evenness_mean richness_mean simpson_mean   shannon_mean  func.div_mean
# 2009       434.8777     12.18400     0.5377376      39.94574     7.756119    12.77735    2.529140
# 2010       359.3104     10.09484     0.5412410      35.79683     7.391117    12.01082    2.484178
# 2011       413.8082     14.84360     0.5325160      40.97761     7.914998    13.31994    2.704003

#abundance 
#(1-(359.3104/434.8777))*100 = 17.37% 
#(1-(359.3104/413.8082))*100 = 13.16982

#biomass 
#(1-(10.09484/12.18400))*100 = 17.14% 
#(1-(10.09484/14.84360))*100 = 31.99197

#richness 
#(1-(35.79683/39.94574))*100 = 10.38%
#(1-(35.79683/40.97761))*100 = 12.64295

#simpson 
#(1-(7.391117/7.756119))*100 = 4.70%
#(1-(7.391117/7.914998))*100 = 6.618839

#shannon 
#(1-(12.01082/12.77735))*100 = 5.99%
#(1-(12.01082/13.31994))*100 = 9.828272

#functional 
#(1-(2.484178/2.529140))*100 = 1.7%
#(1-(2.484178/2.704003))*100 = 8.129614

```

```{r compare diversity indices}

all_matrices_data = read_rds("psu_matrices_data_rds")

stats_all_matrices_data = all_matrices_data %>%
    group_by(YEAR) %>% #110 groups 
    summarize(
      abundance_mean = mean(abundance_sum),
      biomass_mean = mean(biomass_sum),
      richness_mean = mean(richness),
      simpson_mean = mean(simpson),
      shannon_mean = mean(shannon),
      func.div_mean = mean(func.div),
      evenness_mean = mean(evenness))

percent_div_to_rich = stats_all_matrices_data %>%
  select(richness_mean, simpson_mean, shannon_mean) %>%
  mutate(simp_rich = (simpson_mean/richness_mean),
         shan_rich = (shannon_mean/richness_mean)) %>%
  summarize(simp_rich_avg = mean(simp_rich), #0.2134
            shan_rich_avg = mean(shan_rich)) #0.3494 

all_matrices_data_with_subregion = read_rds("psu_matrices_data_with_subregion_rds")
  
  matrices_strat_grouped_with_subregion = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    filter(SUBREGION_DOMAIN != "BiscBay") %>% 
    group_by(YEAR, SUBREGION_DOMAIN) %>% 
    summarize(      
      abundance_mean = mean(abundance_sum),
      biomass_mean = mean(biomass_sum),
      richness_mean = mean(richness),
      simpson_mean = mean(simpson),
      shannon_mean = mean(shannon),
      func.div_mean = mean(func.div),
      evenness_mean = mean(evenness))
  
  compare_region_abun = matrices_strat_grouped_with_subregion %>% 
    select(YEAR,SUBREGION_DOMAIN,abundance_mean) %>%
    group_by(SUBREGION_DOMAIN) %>% 
    spread(SUBREGION_DOMAIN, abundance_mean, fill=0) %>%
    mutate(middle_lower = (Middle/Lower),
           middle_upper = (Middle/Upper)) %>%
    summarize(
      middle_lower_mean = mean(middle_lower),
      middle_upper_mean = mean(middle_upper))
  
  #middle_lower_mean middle_upper_mean
  # 1.05506         0.9861887
  
    compare_region_simp = matrices_strat_grouped_with_subregion %>% 
    select(YEAR,SUBREGION_DOMAIN,simpson_mean) %>%
    group_by(SUBREGION_DOMAIN) %>% 
    spread(SUBREGION_DOMAIN, simpson_mean, fill=0) %>%
    mutate(middle_lower = (Middle/Lower),
           middle_upper = (Middle/Upper)) %>%
    summarize(
      middle_lower_mean = mean(middle_lower),
      middle_upper_mean = mean(middle_upper))
    
   # middle_lower_mean middle_upper_mean
   # 0.8788093         0.8836824
   # Simp LK 12% > MK
   # Simp UK 11% > MK
 
    compare_region_shan = matrices_strat_grouped_with_subregion %>% 
    select(YEAR,SUBREGION_DOMAIN,shannon_mean) %>%
    group_by(SUBREGION_DOMAIN) %>% 
    spread(SUBREGION_DOMAIN, shannon_mean, fill=0) %>%
    mutate(middle_lower = (Middle/Lower),
           middle_upper = (Middle/Upper)) %>%
    summarize(
      middle_lower_mean = mean(middle_lower),
      middle_upper_mean = mean(middle_upper))
    
   # middle_lower_mean middle_upper_mean
   # 0.8796215         0.89113764
  # Shan Lower is 12% > MK 
  # Shan Upper is 11% > MK
    
    compare_region_func = matrices_strat_grouped_with_subregion %>% 
    select(YEAR,SUBREGION_DOMAIN,func.div_mean) %>%
    group_by(SUBREGION_DOMAIN) %>% 
    spread(SUBREGION_DOMAIN, func.div_mean, fill=0) %>%
    mutate(middle_lower = (Middle/Lower),
           middle_upper = (Middle/Upper)) %>%
    summarize(
      middle_lower_mean = (1-mean(middle_lower))*100,
      middle_upper_mean = (1-mean(middle_upper))*100)
    
   # middle_lower_mean middle_upper_mean
   # 0.9072941         0.928107
  # FD Lower is 9% > MK 
  # FD Upper is 7% > MK
  
```

Arc MAP with MPA's

```{r maps}

all_matrices_data = read_rds("psu_matrices_data_rds")

mpa_lat_long = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LAT_DEGREES,LON_DEGREES,MPA_NR,STRAT) %>%
  filter(MPA_NR != "0") %>% 
  filter(YEAR == "2016")%>%
  arrange(MPA_NR)

write_csv(mpa_lat_long, "big_csv/mpa_lat_long.csv")

strata_numbered = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LAT_DEGREES, LON_DEGREES, STRAT) %>%
  mutate(STRAT_NR = ifelse(grepl("HRRF", STRAT),"1",
                           ifelse(grepl("FDLR", STRAT), "2", 
                                  ifelse(grepl("FMLR", STRAT), "3",
                                         ifelse(grepl("FSLR", STRAT), "4",
                                                ifelse(grepl("INPR", STRAT), "5",
                                                       ifelse(grepl("MCPR", STRAT), "6",
                                                              ifelse(grepl("OFPR", STRAT), "7","IDK"))))))))

write_csv(strata_numbered, "strata_numbered.csv")
         

```

```{r thesis word cloud}

library(tm)
library(wordcloud)
library(SnowballC)

#read in text file 
modified_thesis = Corpus(DirSource("word_cloud/"))
inspect(modified_thesis)
modified_thesis = tm_map(modified_thesis, stripWhitespace)  #strip white space 
modified_thesis = tm_map(modified_thesis, tolower) #to lower case 
#modified_thesis = tm_map(modified_thesis, stemDocument) #comment out b/c cuts off words 
modified_thesis = tm_map(modified_thesis, removeNumbers)  #remove numbers 
modified_thesis = tm_map(modified_thesis, removePunctuation) #remove punctuation 
modified_thesis = tm_map(modified_thesis, removeWords, stopwords("english")) #remove common english words 
remove_these = c("also", "can","one","using", "two")
modified_thesis = tm_map(modified_thesis, removeWords,remove_these)

tdm_thesis = TermDocumentMatrix(modified_thesis)%>% #create TDM
  as.matrix() 
sum_thesis = sort(rowSums(tdm_thesis), decreasing = T) #frequency of each word 
d = data.frame(word=names(sum_thesis), freq=sum_thesis)
head(d, 25)
table(d$freq)

png("wordcloud_packages.png", width=1280,height=800)
wordcloud(d$word,d$freq, scale=c(8,.2),min.freq=3,
max.words=Inf, random.order=FALSE, rot.per=.15, colors=brewer.pal(8,"Dark2"))
dev.off()

png("wordcloud_packages_rainbow_blue8.png", width=1280,height=800)
par(bg="navy") 
wordcloud(d$word,d$freq, scale=c(8,.2),min.freq=3,
max.words=Inf, random.order=FALSE, rot.per=.15, colors=grDevices::rainbow(8)) #colors=grDevices::topo.colors(8)) #colors=grDevices::rainbow(8))
dev.off()

png("wordcloud_packages_2.png", width=1280,height=800)
wordcloud(d$word,d$freq, scale=c(8,.2),min.freq=3,
max.words=200, random.order=FALSE, rot.per=.15, colors=brewer.pal(8,"Dark2"))
dev.off()

png("wordcloud_packages_3.png", width=800,height=400)
wordcloud(d$word,d$freq, scale=c(8,.2),min.freq=3,
max.words=200, random.order=FALSE, rot.per=.15, colors=brewer.pal(8,"Dark2"))
dev.off()
#wordcloud(modified_thesis, scale = c(2,0.5), max.words = 100, random.order = F, rot.per=0.25, use.r.layout = F, colors=brewer.pal(8,"Dark2"))

```

```{r pp examples}

#2000, PSU = 211U, STRAT = HRRF
# sum = 548.977, Protected = 1 
#Richness = 50, Simpson = 8.517275, Shannon = 14.303620, Functional diversity = 2.832026
#Eveness = 0.5475674, 9 â€“ 27 â€“ 2000, 25.12288, -80.29665

pp_example = all_matrices_data %>% 
  #arrange(desc(richness))
  filter(STRAT == "HRRF") %>%
  filter(PRIMARY_SAMPLE_UNIT == "211U")%>%
  filter(YEAR == "2000")

pp_example2 <- psu_fk_abun_no_spp %>%
  filter(YEAR == "2000") %>%
  filter(PRIMARY_SAMPLE_UNIT == "211U")%>%
  filter(!abundance == "0")  %>%
  arrange(desc(abundance))

pp_example3 = left_join(pp_example2, family, by= "SPECIES_CD")%>%
  select(SPECIES_CD, abundance, COMNAME)

diversity_example = read_csv("pp_diversity_example2.csv")

   
  div_example = diversity_example %>%  
    select(SPECIES_CD,abundance) %>%
    spread(SPECIES_CD,abundance)

richness = specnumber(div_example[,]) #24 
simpson = diversity(div_example[,], index = 'simpson') #0.8653564
shannon = (diversity(div_example[,],  index = 'shannon')) #2.413305
simpson_en = 1/(1 - diversity(div_example[,], index = 'simpson')) #7.427017
shannon_en = exp(diversity(div_example[,],  index = 'shannon')) #11.178

#post hurricane event examples
  div_example_post = diversity_example %>%  
    #filter(post_abundance != "0") %>%
    select(SPECIES_CD,post_abundance) %>%
    spread(SPECIES_CD,post_abundance)
  
  post_richness = specnumber(div_example_post[,]) #12
  post_simpson = diversity(div_example_post[,], index = 'simpson') #0.8417122
  post_shannon = (diversity(div_example_post[,],  index = 'shannon')) #2.094478
  post_simpson_en = 1/(1 - diversity(div_example_post[,], index = 'simpson')) #6.317604
  post_shannon_en = exp(diversity(div_example_post[,],  index = 'shannon')) #8.121199


